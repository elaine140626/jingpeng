<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.truckscale.basicSetting.dao.VehicleSettingDao">
	<!-- 查询所有车辆信息 -->
	<select id="getAllCarInfo" parameterType="java.util.Map" resultType="com.truckscale.basicSetting.model.CarInfo">
		SELECT
			c.Id              AS id,-- 自增长id 
			c.CarNumber       AS carNumber,-- 车辆编码
			c.PlateNumber     AS plateNumber,-- 车牌号码
			c.CarModel        AS carModel,-- 车辆型号
			c.DriverName      AS driverName,-- 司机姓名
			c.Telephone       AS telephone,-- 联系电话
			c.TareWeight      AS tareWeight,-- 皮重
			c.TransportUnitId AS transportUnitId,-- 运输单位id
		  	t.CarOwnerName    AS carOwnerName,-- 车主姓名
		  	t.TransportCompanyName AS transportCompanyName,-- 运输单位
		  	c.InOrTemporary   AS inOrTemporary, -- 厂内车辆/临时车辆 0:厂内车辆 1:临时车辆
			c.Remarks         AS remarks,-- 备注
			c.IsDel           AS isDel,-- 删除标记
			c.Creater         AS creater,-- 创建人
			c.CreaterDate     AS createrDate,-- 创建日期
			c.Reviser         AS reviser,-- 修改人
			c.ReviserDate     AS reviserDate -- 修改日期
		FROM
			carinfo c
			LEFT JOIN transportcompany t
			ON t.Id = c.TransportUnitId AND t.IsDel = 0
		WHERE
			c.IsDel = 0
			AND c.InOrTemporary = 0
			<if test="id != null and id != 0">
				AND c.Id = #{id}
			</if>
			<if test="plateNumber != null and plateNumber != ''">
				AND c.PlateNumber like '%${plateNumber}%'
			</if>
			<if test="transportCompanyName != null and transportCompanyName != ''">
				AND t.TransportCompanyName like '%${transportCompanyName}%'
			</if>
		ORDER BY
			c.Id DESC
	</select>
	<!-- 查询运输单位 -->
	<select id="getTransportCompanyList" resultType="java.util.Map" parameterType="com.truckscale.basicSetting.model.TransportCompany">
		SELECT
			Id                     AS id,-- 自增长id
			TransportCompanyNumber AS transportCompanyNumber,-- 运输单位编号
			TransportCompanyName   AS transportCompanyName,-- 运输单位
			CarOwnerName           AS carOwnerName,-- 车主姓名
			CarOwnerTelephone      AS carOwnerTelephone,-- 车主电话
			Remarks                AS remarks,-- 备注
			IsDel                  AS isDel,-- 删除标记(0未删除， 1删除)
			Creater                AS creater,-- 创建人
			CreaterDate            AS createrDate,-- 创建日期
			Reviser                AS reviser,-- 修改人
			ReviserDate            AS reviserDate-- 修改日期
		FROM
			transportcompany -- 运输单位表
		WHERE
			IsDel = 0
			<if test="id != null and id != 0">
				AND Id = #{id}
			</if>
		ORDER BY Id DESC
	</select>
	<!-- 车辆牌号去重 -->
	<select id="getCarInfo" parameterType="java.util.Map" resultType="com.truckscale.basicSetting.model.CarInfo">
		SELECT
			c.Id              AS id,-- 自增长id 
			c.CarNumber       AS carNumber,-- 车辆编码
			c.PlateNumber     AS plateNumber,-- 车牌号码
			c.CarModel        AS carModel,-- 车辆型号
			c.DriverName      AS driverName,-- 司机姓名
			c.Telephone       AS telephone,-- 联系电话
			c.TareWeight      AS tareWeight,-- 皮重
			c.TransportUnitId AS transportUnitId,-- 运输单位id
			c.Remarks         AS remarks,-- 备注
			c.IsDel           AS isDel,-- 删除标记
			c.Creater         AS creater,-- 创建人
			c.CreaterDate     AS createrDate,-- 创建日期
			c.Reviser         AS reviser,-- 修改人
			c.ReviserDate     AS reviserDate -- 修改日期
		FROM
			carinfo c
		WHERE 
			c.IsDel = 0
			AND c.InOrTemporary = 0
			AND c.PlateNumber = #{plateNumber}
	</select>
	<!-- 添加车辆信息 -->
	<insert id="addCarInfo" parameterType="com.truckscale.basicSetting.model.CarInfo">
		INSERT 
			INTO carinfo( 
			  CarNumber
			  , PlateNumber
			  , CarModel
			  , DriverName
			  , Telephone
			  , TareWeight
			  , TransportUnitId
			  , InOrTemporary
			  , Remarks
			  , IsDel
			  , Creater
			  , CreaterDate
			) 
			VALUES ( 
			  #{carNumber}
			  , #{plateNumber}
			  , #{carModel}
			  , #{driverName}
			  , #{telephone}
			  , #{tareWeight}
			  , #{transportUnitId}
			  , 0
			  , #{remarks}
			  , 0
			  , #{creater}
			  , NOW()
			) 
	</insert>
	<!-- 修改车辆信息 -->
	<update id="updateCarInfo" parameterType="com.truckscale.basicSetting.model.CarInfo">
		UPDATE truckscale.carinfo 
			SET
			  CarNumber = #{carNumber}
			  , PlateNumber = #{plateNumber}
			  , CarModel = #{carModel}
			  , DriverName = #{driverName}
			  , Telephone = #{telephone}
			  , TareWeight = #{tareWeight}
			  , TransportUnitId = #{transportUnitId}
			  , InOrTemporary = 0
			  , Remarks = #{remarks}
			  , IsDel = 0
			  , Reviser = #{reviser}
			  , ReviserDate = NOW()
			WHERE
			  Id = #{id}
	</update>
	<!-- 删除车辆信息 -->
	<update id="deleteCarInfo" parameterType="com.truckscale.basicSetting.model.CarInfo">
		UPDATE truckscale.carinfo 
			SET
			  IsDel = 1
			  , Reviser = #{reviser}
			  , ReviserDate = NOW()
			WHERE
			  Id = #{id}
	</update>
	<!-- 车辆编号自增 -->
	<select id="getCarInfoCount" resultType="com.truckscale.basicSetting.model.CarInfo">
		SELECT
			c.Id              AS id,-- 自增长id 
			c.CarNumber       AS carNumber,-- 车辆编码
			c.PlateNumber     AS plateNumber,-- 车牌号码
			c.CarModel        AS carModel,-- 车辆型号
			c.DriverName      AS driverName,-- 司机姓名
			c.Telephone       AS telephone,-- 联系电话
			c.TareWeight      AS tareWeight,-- 皮重
			c.TransportUnitId AS transportUnitId,-- 运输单位id
			c.Remarks         AS remarks,-- 备注
			c.IsDel           AS isDel,-- 删除标记
			c.Creater         AS creater,-- 创建人
			c.CreaterDate     AS createrDate,-- 创建日期
			c.Reviser         AS reviser,-- 修改人
			c.ReviserDate     AS reviserDate -- 修改日期
		FROM
			carinfo c
		WHERE 
			c.IsDel = 0
			AND c.InOrTemporary = 0
		ORDER BY c.CreaterDate 	DESC LIMIT 1
	</select>
	<!-- 判断车辆信息是否被关联 -->
	<select id="getWeighingQueryEntityInfo" parameterType="java.util.Map" resultType="java.util.Map">
		select
			 e.Id -- 自增长id
			,e.SerialId -- 流水号
			,e.FeedCompanyId
		    ,e.ReceiveUnitId
			,e.MaterielNameId
			,e.GrossWeight -- 毛重（t）
			,e.GrossWeightCount
			,e.MeasurementMode -- 计量方式
			,e.Deduction -- 扣除量或扣除率（数据字典）
			,e.DriverName -- 司机姓名
			,e.TareWeight -- 皮重（t）
			,e.TareWeightCount
			,e.NetWeight -- 净重（t）
			,e.EndAddress -- 止运地
			,e.StartAddress -- 起运地
			,e.Temperature -- 温度（℃）
			,e.Route -- 路线，桩号
			,e.RatioOfOil -- 油石比
			,e.OutOrEnter -- 出/入库：0出 1入
			,e.IsFile -- 是否归档0:是 1:否
			,e.Remarks -- 备注
			,e.IsDel
			,e.Creater
			,DATE_FORMAT(e.CreaterDate,'%Y-%m-%d %H:%i:%s') as CreaterDate
			,e.Reviser
			,e.ReviserDate
		from
			exportmeasure e -- 出库单表
		WHERE 
			e.IsDel = 0
			and e.CarId = #{id} 
	</select>
</mapper>