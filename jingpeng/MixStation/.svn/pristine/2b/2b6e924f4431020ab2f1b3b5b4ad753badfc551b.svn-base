package com.blindSample.controller;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.blindSample.model.PlatformUserInfo;
import com.blindSample.model.SampleIntelligenceEntity;
import com.blindSample.model.TestCollectionEntity;
import com.blindSample.model.TestInfo;
import com.blindSample.model.TestPageInfos;
import com.blindSample.model.TestRoomInfo;
import com.blindSample.model.TestUser_Info;
import com.blindSample.service.TestCollectionService;
import com.blindSample.util.MessageUtilBlindSample;
import com.jingpeng.dao.DataTablesResponseInfo;
import com.jingpeng.model.ResponseInfo;
import com.kdt.base.exception.BusinessException;

@Controller
@RequestMapping("/TestCollection")
public class TestCollectionController {

	@Autowired
	private TestCollectionService testCollectionService;

	/**
	 * 试验收样
	 * 
	 * @return
	 */
	@RequestMapping("/shiyan_3.html")
	public String getTestCollection() {
		return "/BlindnessTest/shiyan_3";
	}

	/**
	 * 获取试验室名称列表
	 * 
	 * @param request
	 * @return
	 * @throws BusinessException
	 */
	@RequestMapping("/getTestRoomList")
	@ResponseBody
	public List<TestRoomInfo> getTestRoomList(HttpServletRequest request) throws BusinessException {
		HttpSession session = request.getSession();
		// 获取当前登录用户的信息
		TestUser_Info obj = (TestUser_Info) session.getAttribute("user");

		// 检索条件设置
		Map<String, Object> map = new HashMap<String, Object>();
		// 获取当前登录用户的id
		map.put("user_id", obj.getId());

		// 根据用户权限获取试验室名称list
		List<TestRoomInfo> testRoomInfoList = testCollectionService.getTestRoomList(map);

		// 判空处理
		if (testRoomInfoList == null || testRoomInfoList.size() <= 0) {
			testRoomInfoList = new ArrayList<TestRoomInfo>();
		}
		return testRoomInfoList;
	}

	/**
	 * 获取试验名称列表
	 * 
	 * @param request
	 * @return
	 * @throws BusinessException
	 */
	@RequestMapping("/getTestNameList")
	@ResponseBody
	public List<TestPageInfos> getTestNameList(HttpServletRequest request) throws BusinessException {
		Map<String, Object> map = new HashMap<String, Object>();
		// 获取试验名称列表
		List<TestPageInfos> testPageInfosList = testCollectionService.getTestNameList(map);
		// 判空处理
		if (testPageInfosList == null || testPageInfosList.size() <= 0) {
			testPageInfosList = new ArrayList<TestPageInfos>();
		}
		return testPageInfosList;
	}

	/**
	 * 获取用户权限
	 * 
	 * @param request
	 * @return
	 * @throws BusinessException
	 */
	@RequestMapping("/getUserInfo")
	@ResponseBody
	public PlatformUserInfo getUserInfo(HttpServletRequest request) throws BusinessException {
		HttpSession session = request.getSession();
		// 获取当前登录用户的信息
		TestUser_Info obj = (TestUser_Info) session.getAttribute("user");
		// 检索条件设置
		Map<String, Object> map = new HashMap<String, Object>();
		map.put("user_id", obj.getId());
		map.put("roleType", 1);
		PlatformUserInfo data = new PlatformUserInfo();
		// 获取试验名称列表
		List<PlatformUserInfo> userInfo = testCollectionService.getUserInfo(map);
		// 判空处理
		if (userInfo == null || userInfo.size() <= 0) {
			userInfo = new ArrayList<PlatformUserInfo>();
		} else {
			data = userInfo.get(0);
		}
		return data;
	}

	/**
	 * 根据用户选择的试验室名称获取相应的试验员
	 * 
	 * @param request
	 * @return
	 * @throws BusinessException
	 */
	@RequestMapping("/getTestOperatorList")
	@ResponseBody
	public List<TestInfo> getTestOperatorList(HttpServletRequest request, @RequestParam Map<String, Object> param)
			throws BusinessException {
		HttpSession session = request.getSession();

		// 获取当前登录用户的信息
		TestUser_Info obj = (TestUser_Info) session.getAttribute("user");
		// 获取选中的试验室唯一标识
		String uniqueIdentifiers = param.get("uniqueIdentifiers").toString();
		String[] uniqueIdentifierList = uniqueIdentifiers.split(",");
		List<TestInfo> testInfoList = new ArrayList<TestInfo>();
		// 检索条件设置
		Map<String, Object> map = new HashMap<String, Object>();
		map.put("user_id", obj.getId());

		// 循环设置试验室唯一标识
		if (uniqueIdentifierList.length > 0) {
			for (int i = 0; i < uniqueIdentifierList.length; i++) {
				map.put("uniqueIdentifier", uniqueIdentifierList[i]);
				// 根据用户权限获取试验室名称list
				List<TestInfo> list = testCollectionService.getTestOperatorList(map);
				if (list != null && list.size() > 0) {
					testInfoList.addAll(list);
				}
			}
		}

		// 判空处理
		if (testInfoList == null || testInfoList.size() <= 0) {
			testInfoList = new ArrayList<TestInfo>();
		}
		return testInfoList;
	}

	/**
	 * 获取试验基本信息列表
	 * 
	 * @param request
	 * @return
	 * @throws BusinessException
	 */
	@RequestMapping("/getTestInfoList")
	@ResponseBody
	public DataTablesResponseInfo getTestInfoList(@RequestParam Map<String, Object> param) throws BusinessException {
		DataTablesResponseInfo dtri = new DataTablesResponseInfo();

		// 检索条件设置
		Map<String, Object> map = new HashMap<String, Object>();
		if (!param.get("testNameId").toString().equals("")) {
			// 获取页面的试验名称id
			map.put("testNameId", Integer.parseInt(param.get("testNameId").toString()));
		} else {
			map.put("testNameId", 0);
		}

		// 获取页面中输入的试验员
		map.put("testOperator", param.get("testOperator").toString());
		// 获取选中的试验室唯一标识
		String uniqueIdentifiers = param.get("uniqueIdentifier").toString();
		String[] uniqueIdentifierList = uniqueIdentifiers.split(",");
		List<TestCollectionEntity> testInfoList = new ArrayList<TestCollectionEntity>();

		// 循环设置试验室唯一标识
		if (uniqueIdentifierList.length > 0) {
			for (int i = 0; i < uniqueIdentifierList.length; i++) {
				map.put("uniqueIdentifier", uniqueIdentifierList[i]);
				// 根据用户权限获取试验室名称list
				List<TestCollectionEntity> list = testCollectionService.getTestInfoList(map);
				if (list != null && list.size() > 0) {
					testInfoList.addAll(list);
				}
			}
		}

		// 判空处理
		if (testInfoList != null && testInfoList.size() > 0) {
			// 循环设置序列号
			for (int i = 0; i < testInfoList.size(); i++) {
				testInfoList.get(i).setRow(i + 1);
			}
		}
		dtri.setData(testInfoList);
		return dtri;
	}

	/**
	 * 判断试验是否已经被收样
	 * 
	 * @param request
	 * @return
	 * @throws BusinessException
	 */
	@RequestMapping("/getExistFlag")
	@ResponseBody
	public int getExistFlag(HttpServletRequest request,
			@RequestParam Map<String, Object> param) throws BusinessException {

		// 根据二维码判断试验是否
		int result = testCollectionService.getExistFlag(param);

		return result;
	}
	
	/**
	 * 根据二维码获取相应收样信息
	 * 
	 * @param request
	 * @return
	 * @throws BusinessException
	 */
	@RequestMapping("/getSampleIntelligence")
	@ResponseBody
	public List<SampleIntelligenceEntity> getSampleIntelligence(HttpServletRequest request,
			@RequestParam Map<String, Object> param) throws BusinessException {

		// 根据二维码获取相应收样信息
		List<SampleIntelligenceEntity> List = testCollectionService.getSampleIntelligence(param);
		// 判空处理
		if (List == null || List.size() <= 0) {
			List = new ArrayList<SampleIntelligenceEntity>();
		}
		return List;
	}

	/**
	 * 保存按钮click
	 * 
	 * @param request
	 * @return
	 * @throws BusinessException
	 */
	@RequestMapping("/addTestInfo")
	public @ResponseBody ResponseInfo addTestInfo(HttpServletRequest request, @RequestParam Map<String, Object> param)
			throws BusinessException {
		ResponseInfo info = new ResponseInfo();
		try {
			HttpSession session = request.getSession();

			// 获取当前登录用户的信息
			TestUser_Info obj = (TestUser_Info) session.getAttribute("user");
			param.put("user_id", obj.getId());
			int result = testCollectionService.addTestInfo(param);
			if (result > 0) {
				// 成功处理请求提示 200
				info.setCode(MessageUtilBlindSample.SUCCESSFUL_OPERATION_REQUESTS);
				// 操作成功提示
				info.setMessage(MessageUtilBlindSample.SUCCESSFUL_OPERATION);
			} else {
				// 服务器遇到错误 500
				info.setCode(MessageUtilBlindSample.SERVER_ERROR);
				// 操作失败提示
				info.setMessage(MessageUtilBlindSample.OPERATION_FAILED);
			}
		} catch (BusinessException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
			// 服务器遇到错误 500
			info.setCode(MessageUtilBlindSample.SERVER_ERROR);
			// 操作失败提示
			info.setMessage(MessageUtilBlindSample.OPERATION_FAILED);
		}
		return info;
	}
}
