var Token;
var baseUrl = "";
var isVideoAdd=new Array();
var videoParams = {};
$(function(){
	$("#getAll").hide();
	baseUrl = getContextPath();
	$("#getJpNameAll").hide();
		var params = {
			        "appKey": "7310dea0af7d4dceb69b84e1c850205e",
			        "appSecret": "211e320d80534dcd5cd4574244004530"
			    };
		$.ajax({
			url:"../FluorescentCloud/getAccessToken.action",
		    async:false,
			data:params,
		    dataType: "json",
			success:function(data){
				console.log(data);
				var obj = JSON.parse(data);
				Token =obj.data.accessToken;
				videoParams.AppKey = params.appKey;
				videoParams.AccessToken = Token;
			},
			error:function(e){
				alert(e)
			}
		});
		
		var paramsToken = {"accessToken":Token};
		
		$.ajax({
			url:'../FluorescentCloud/getMonitorAll.action',
		    async:false,
			data:paramsToken,
		    dataType: "json",
			success:function(monitordata){
				var monitorAll = JSON.parse(monitordata);
					$.each(monitorAll.data,function (i,v) {
					 $('<option></option>').attr("value", v.deviceSerial).html(v.deviceName).appendTo($("#getJpName"));
				})
				
			}
		});
})

function JpisShow(){
	$("#getJpNameAll").show();
}

function addJp(){
	var deviceSerialAll = $("#JpList").children();
	var isHave = true;
	var code = $("#getJpName").val();
	var deviceSerial = code+":1";
	 var addJpParams = {
		        "accessToken": Token,
		        "source": deviceSerial
		    };
	 $.ajax({
			url:'../FluorescentCloud/getMonitorUrl.action',
		    async:false,
			data:addJpParams,
		    dataType: "json",
			success:function(data){
				var obj = JSON.parse(data);
				var videoId = obj.data[0].deviceSerial;
				isHave = $.inArray(videoId,isVideoAdd);
				if(isHave){
				var url = obj.data[0].rtmp;
				$("#getJpNameAll").hide();
	        	var vhtml =["<div name=\""+videoId+"\">",
	        		"<video id=\""+videoId+"\" poster=\"\" controls playsInline webkit-playsinline autoplay>",
	        		"<source src=\""+url+"\" type=\"rtmp/flv\" />",
	        		"</video>",
	        		"<p onclick=\"Jpcontroller(0,\'"+videoId+"\')\">上</p>",
	        		"<p onclick=\"Jpcontroller(1,\'"+videoId+"\')\">下</p>",
	        		"<p onclick=\"Jpcontroller(2,\'"+videoId+"\')\">左</p>",
	        		"<p onclick=\"Jpcontroller(3,\'"+videoId+"\')\">右</p>",
	        		"<p onclick=\"Jpcontroller(4,\'"+videoId+"\')\">左上</p>",
	        		"<p onclick=\"Jpcontroller(5,\'"+videoId+"\')\">左下</p>",
	        		"<p onclick=\"Jpcontroller(6,\'"+videoId+"\')\">右上</p>",
	        		"<p onclick=\"Jpcontroller(7,\'"+videoId+"\')\">右下</p>",
	        		"<p onclick=\"Jpcontroller(8,\'"+videoId+"\')\">放大</p>",
	        		"<p onclick=\"Jpcontroller(9,\'"+videoId+"\')\">缩小</p>",
	        		"<p onclick=\"Jpcontroller(10,\'"+videoId+"\')\">近焦距</p>",
	        		"<p onclick=\"Jpcontroller(11,\'"+videoId+"\')\">远焦距</p>",
	        		"<p onclick=\"Jpstop(\'"+videoId+"\')\">停</p>",
	        		"<p onclick=\"JpisDel(\'"+videoId+"\')\">移除设备</p>",
	        		"</div>"].join("");
	        	$("#JpList").append(vhtml);
	        	new EZUIPlayer(videoId);
				
				//IE 264 265 编码格式 兼容 
/*				var vhtml =["<div name=\""+videoId+"\">",
	        		"<p onclick=\"Jpcontroller(0,\'"+videoId+"\')\">上</p>",
	        		"<p onclick=\"Jpcontroller(1,\'"+videoId+"\')\">下</p>",
	        		"<p onclick=\"Jpcontroller(2,\'"+videoId+"\')\">左</p>",
	        		"<p onclick=\"Jpcontroller(3,\'"+videoId+"\')\">右</p>",
	        		"<p onclick=\"Jpcontroller(4,\'"+videoId+"\')\">左上</p>",
	        		"<p onclick=\"Jpcontroller(5,\'"+videoId+"\')\">左下</p>",
	        		"<p onclick=\"Jpcontroller(6,\'"+videoId+"\')\">右上</p>",
	        		"<p onclick=\"Jpcontroller(7,\'"+videoId+"\')\">右下</p>",
	        		"<p onclick=\"Jpcontroller(8,\'"+videoId+"\')\">放大</p>",
	        		"<p onclick=\"Jpcontroller(9,\'"+videoId+"\')\">缩小</p>",
	        		"<p onclick=\"Jpcontroller(10,\'"+videoId+"\')\">近焦距</p>",
	        		"<p onclick=\"Jpcontroller(11,\'"+videoId+"\')\">远焦距</p>",
	        		"<p onclick=\"Jpstop(\'"+videoId+"\')\">停</p>",
	        		"<p onclick=\"JpisDel(\'"+videoId+"\')\">移除设备</p>",
	        		"</div>"].join("");;
	        		$("#JpListIE").append(vhtml);
				var ezopenUrl = "ezopen://open.ys7.com/"+videoId+"/1.hd.live";
				videoParams.Url = ezopenUrl;
				$("#dataPanel").text(JSON.stringify(videoParams))*/
				
				
	        	isVideoAdd.push(videoId);
				}else{
					alert("你已经添加该设备")
				}
			}
		});
}

function Jpcontroller(id,deviceSerial){
	
	 var params = {
		        "accessToken": Token,
		        "deviceSerial": deviceSerial,
		        "channelNo": 1,
		        "direction": id,
		        "speed": 1
		    };
		$.ajax({
			url:'../FluorescentCloud/controllerJp.action',
		    async:false,
			data:params,
		    dataType: "json",
			success:function(data){
				var obj = JSON.parse(data);
				//var code =obj.msg;
				if(obj.code=='60000'){
					alert("不支持云台设备")
				}
			}
		});
}

function Jpstop(deviceSerial){
	var params = {
	        "accessToken":Token,
	        "deviceSerial": deviceSerial,
	        "channelNo": 1
	    };
	$.ajax({
		url:'../FluorescentCloud/controllerJpStop.action',
	    async:false,
		data:params,
	    dataType: "json",
		success:function(data){
			var obj = JSON.parse(data);
			var code =obj.msg;
		}
	});
}

function login(){
	var password = $("#JpPassWord").val();
	if(password==123){
		$("#getAll").show();
		$("#isLogin").hide();
	}else{
		alert("密码错误")
	}
}

function JpisDel(name){
	$("div[name='"+name+"']").remove();
	isVideoAdd.splice($.inArray(name,isVideoAdd),1);
}
