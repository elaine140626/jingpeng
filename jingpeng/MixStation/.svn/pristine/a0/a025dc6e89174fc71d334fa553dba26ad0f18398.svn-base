var baseUrl = "";
var thisIds = "";
$(function() {
	baseUrl = getContextPath();
	$.ajax({
        type: "post",
        url: "../testUserInfo/getPtUserInfo",
        data:{},
        async:false,
        dataType: "json",
        success: function (data) {
        	console.log(data);
        	//获取当前登录人做显示
        	$(".userid").html(data.userName);
        	thisIds = data.id;
        }
    });
	
	// 获取平台用户信息
	getList();
	
});

//获取前页面参数
function getUrlParam(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
    var r = window.location.search.substr(1).match(reg); //匹配目标参数
    if(r != null){
        return decodeURIComponent(r[2]);
//这里为什么是从第三个字符解析呢？不知道这样理解对不对，因为路径后面的参数形式为参数名=参数值，而第一个字符为参数名，第二个为=，第三个就为参数值了。。。因为下面调用的时候得出的就是参数值
    }
    return null;//返回参数值
}

// 用户的list
function getList() {
	$.ajax({
		type : "POST",
		url : baseUrl + "/testUserInfo/getPtUserList",
		data : {},
		dataType : "json",
		success : function(data) {
			var list = data.data;
			$("#testType").attr("style","display:''");
			$("#orgType").attr("style","display:''");
			$("#pt").attr("style","display:''");
			$("#app").attr("style","display:none");
			$("#roleType").attr("style","display:''");
			$("#pt").attr("style","display:''");
			$("#app").attr("style","display:none");
	    	html = "";

    		// 试验室名称
    		var testName = "|";
	    	for(var i = 0; i < list.userTsetDetailed.length; i++) {
	    		testName +=list.userTsetDetailed[i].TestRoomName+"|"
	    	}
	    	// 拌合站名称
	    	var orgName = "|";
	    	for(var i = 0; i < list.userOrgDetailed.length; i++) {
	    		orgName +=list.userOrgDetailed[i].Org_Name+"|"
	    	}
    		html += '<tr>'
				+'<td>'+1+'</td>'
                +'<td>'+list.userInfo.userCode+'</td>'
                +'<td>'+list.userInfo.name+'</td>'
                +'<td>'+testName+'</td>'
                +'<td>'+orgName+'</td>'
                +"<td><span><a href='javascript:void(0)' onclick='update(\""+list.userInfo.id+"\")'>修改</a><a href='javascript:void(0)' onclick='del(\""+list.userInfo.id+"\")'>删除</a></span></td>"
                +'</tr>';
	    	$("#list").html(html);
		}
	});
}

// 获取app用户信息
function getAppUserList() {
	$.ajax({
		type : "POST",
		url : "../testUserInfo/getAppUserList",
		data : {
			usercode:"",
			id:""
		},
		dataType : "json",
		success : function(data) {
			
			$("#testType").attr("style","display:none");
			$("#orgType").attr("style","display:none");
			$("#pt").attr("style","display:none");
			$("#app").attr("style","display:''");
			var list = data.data;
	    	html = "";
	    	if(list != null && list.length > 0){
	    		for (var j = 0; j < list.length; j++) {
		    		html += '<tr>'
	    				+'<td>'+(j+1)+'</td>'
		                +'<td>'+list[j].usercode+'</td>'
		                +'<td>'+list[j].name+'</td>'
		                +"<td><span><a href='javascript:void(0)' onclick='updateAppUser(\""+list[j].id+"\")'>修改</a><a href='javascript:void(0)' onclick='delAppUser(\""+list[j].id+"\")'>删除</a></span></td>"
		           +'</tr>'
				}
	    	}else{
	    		html ='<tr>'
    				+'<td>1</td>'
	                +'<td></td>'
	                +'<td></td>'
	                +"<td></td>"
	           +'</tr>'
	    	}
	    	
	    	$("#list").html(html);
		}
	});
}

// 更新app用户信息
function updateAppUser(id) {
	// 修改界面
	window.location.href = "../testUserInfo/user.html?i_id="+id+"&flag=false";
}

//删除app用户信息
function delAppUser(id) {
	$.ajax({
		type : "POST",
		url :"../testUserInfo/deleteAppUser",
		data : {"id":id},
		async:false,
		dataType : "json",
		success : function(data) {
			if(data.code=="success"){
				swal({
					title: data.message,
					type: data.code,
					confirmButtonColor: '#AEDEF4',
					confirmButtonText: '确定',
				},
				function(){
					location.reload();
				});
			}else{
				swal({
					title: data.message,
					type: data.code,
					confirmButtonColor: '#AEDEF4',
					confirmButtonText: '确定',	
				});
			}		
		}
	});
}

// 获取app用户信息
function getAppUserList() {
	$.ajax({
		type : "POST",
		url : "../testUserInfo/getAppUserList",
		data : {
			usercode:"",
			id:""
		},
		dataType : "json",
		success : function(data) {
			$("#roleType").attr("style","display:none");
			$("#pt").attr("style","display:none");
			$("#app").attr("style","display:''");
			var list = data.data;
	    	html = "";
	    	if(list != null && list.length > 0){
	    		for (var j = 0; j < list.length; j++) {
		    		html += '<tr>'
	    				+'<td>'+(j+1)+'</td>'
		                +'<td>'+list[j].usercode+'</td>'
		                +'<td>'+list[j].name+'</td>'
		                +"<td><span><a href='javascript:void(0)' onclick='updateAppUser(\""+list[j].id+"\")'>修改</a><a href='javascript:void(0)' onclick='delAppUser(\""+list[j].id+"\")'>删除</a></span></td>"
		           +'</tr>'
				}
	    	}else{
	    		html ='<tr>'
    				+'<td>1</td>'
	                +'<td></td>'
	                +'<td></td>'
	                +"<td></td>"
	           +'</tr>'
	    	}
	    	
	    	$("#list").html(html);
		}
	});
}

// 更新app用户信息
function updateAppUser(id) {
	// 修改界面
	window.location.href = "../testUserInfo/user.html?i_id="+id+"&flag=false";
}

//删除app用户信息
function delAppUser(id) {
	$.ajax({
		type : "POST",
		url :"../testUserInfo/deleteAppUser",
		data : {"id":id},
		async:false,
		dataType : "json",
		success : function(data) {
			if(data.code=="success"){
				swal({
					title: data.message,
					type: data.code,
					confirmButtonColor: '#AEDEF4',
					confirmButtonText: '确定',
					
				},
				function(){
					location.reload();
				});
			}else{
				swal({
					title: data.message,
					type: data.code,
					confirmButtonColor: '#AEDEF4',
					confirmButtonText: '确定',	
				});
			}		
		}
	});
}

// 更新用户
function update(i_id) {
	window.location.href = baseUrl+"/testUserInfo/user.html?i_id="+i_id;
}


// 删除用户
function del(i_id) {
	if(thisIds == i_id){
		swal("操作失败","不能删除当前登录的账号！", "info");
		return;
	}
	swal({
		title: "确定操作吗？",
		type: "warning",
		showCancelButton: true,
		confirmButtonColor: '#AEDEF4',
		confirmButtonText: '确定',
		cancelButtonText: '取消',
		cancelButtonFont: '微软雅黑',	
	},
	function(){
		$.ajax({
			type : "POST",
			url : baseUrl + "/testUserInfo/deleteUserInfo",
			data : {"id":i_id},
			async:false,
			dataType : "json",
			success : function(data) {
				if(data.code=="success"){
					swal("操作成功",data.message, "info");
					// 返回注册页面
					window.location.href = baseUrl+"/testUserInfo/login.html";
				if(data.code=="200"){
					swal("操作成功",data.message, "info");
					window.location.href = baseUrl+"/testUserInfo/userinfo.html";
				if(data.code=="success"){
					location.reload();
				}else{
					swal("操作失败",data.message, "info");
					return;
				}
			}
		});	
	});
}