<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oil.dao.client.Client_backDao">
	<!-- 获取客户信息数据 -->
    <select id="getClient_back_Tree" resultType="java.util.Map">
	  SELECT
			c.Province,
			a.CustomerName,
			a.Id,
			b.ProvinceId
		FROM
			customerinfo a,
			cityinfo b,
			provinceinfo c
		WHERE
			a.CityId = b.Id
		AND b.ProvinceId = c.Id
		AND a.IsDel = 0
		AND b.IsDel = 0
		AND c.IsDel = 0
		ORDER BY a.Id DESC
	</select>
 <insert id="addClient_back" parameterType="Client_back">
		INSERT 
		INTO visitinfo( 
		  `CustomerId`
		  , `VisitDate`
		  , `VisitForm`
		  , `UserInfoId`
		  , `VisitContent`
		  , `IsVisit`
		  , `Remarks`
		  ,`IsDel`
		) 
		VALUES ( 
		  #{customerId}
		  , #{visitDate}
		  , #{visitForm}
		  , #{userInfoId}
		  , #{visitContent}
		  , 2
		  , #{remarks}
		  ,#{isDel}
		) 
	</insert>
	
	<!-- 查询全部回访形式信息数据 -->
	<select id="getVisitContent"  resultType="Datadictionary">
		select * from Datadictionary where type = '5'
	</select>
	
	<!-- 通过Id查询回访信息数据 -->
	<select id="getVisitContentByCode" parameterType="String"  resultType="Datadictionary">
		select * from Datadictionary where type = '5' AND code=#{code}
	</select>
	
	<!-- 查询全部客户信息数据 -->
	<select id="getCustomerInfo"  resultType="Customerinfo">
		select 
		Id AS uuid,
		Customername,
		CustomerCode
 		from Customerinfo 
 		where IsDel = 0
 		order by Id DESC
	</select>
	
	<!-- 获取客户信息数据 -->
    <select id="getClient_back_List" resultType="java.util.Map">
		SELECT 
		DISTINCT
			p.Province,
			c.CustomerName,
			c.CustomerCode,
			c.Id,
			ci.ProvinceId
		FROM
			visitinfo v
			LEFT JOIN customerinfo c ON v.CustomerId = c.Id
			LEFT JOIN cityinfo ci ON c.CityId = ci.Id
			LEFT JOIN provinceinfo p ON ci.ProvinceId = p.Id
		WHERE
			c.IsDel = 0
		AND 
			v.IsDel = 0
		and
			v.IsVisit = 2
		ORDER BY
			ci.ProvinceId desc
	</select>
    <!-- 查询全部销售员信息数据   -->
	<select id="getUserInfoByCode"  resultType="Userinfo">
	
			select
			  id
			  , name
			from
			  userinfo 
			where
				FIND_IN_SET(1,RoleCode)
			  and IsDel = 0
			order by id desc
			
	</select>
	
	<!-- 查询全部回访信息数据   -->
	<select id="getClient_back"  resultType="Client_back">
		SELECT
			b.Id,
			b.CustomerId,
			b.VisitDate,
			b.VisitForm,
			b.VisitContent,
			b.UserInfoId,
			b.IsVisit,
			b.IsDel,
			b.Remarks,
			c.IsDel AS cIsDel,
			u. NAME AS userInfoName
		FROM
			visitinfo b
		LEFT JOIN customerinfo c ON b.CustomerId = c.id
		LEFT JOIN userinfo u ON b.UserInfoId = u.id
		WHERE
			b.IsDel = 0
		AND 
			b.IsVisit = 2
		ORDER BY b.Id DESC
	</select>
	
	<!-- 通过ID查询全部回访信息数据 -->
	<select id="getClient_backById" parameterType="int"  resultType="Client_back">
		SELECT
			b.Id,
			b.CustomerId,
			b.VisitDate,
			b.VisitForm,
			b.VisitContent,
			b.UserInfoId,
			c.Name AS userInfoName,
			b.IsVisit,
			b.IsDel,
			b.Remarks,
			a.IsDel AS cIsDel
		FROM
			visitinfo b,
			customerinfo a,
			userinfo c
		WHERE
			b.CustomerId = a.Id
		AND b.IsVisit = '2'
		AND b.IsDel = 0
		AND b.UserInfoId = c.Id	
		AND b.id = #{id}
	</select>
	
	<!-- 通过id获取客户信息数据 -->
	<select id="getCustomerinfoById" parameterType="int"  resultType="Customerinfo">
		select * from Customerinfo where  Id=#{id}
	</select>
	
	<!--修改回访客户信息 -->
	<update id="updateClient_back" parameterType="Client_back">
		update visitinfo set
		CustomerId = #{customerId},
		VisitDate = #{visitDate},
		VisitForm =#{visitForm},
		UserInfoId = #{userInfoId},
		VisitContent = #{visitContent},
		IsVisit = 2 ,
		Remarks =#{remarks}
		WHERE Id= #{id}
	</update>
	
	<!--删除回访客户信息 -->
	<update id="delClient_back" parameterType="int">
		update visitinfo set 
		IsDel = 1
		WHERE Id= #{id}
		ANd IsVisit = 2
	</update>
	
	<!-- 根据名称模糊查询 -->
	<select id="findCustomerinfoByName" parameterType="String" resultType="Client_back">
		SELECT
			b.Id,
			b.CustomerId,
			b.VisitDate,
			b.VisitForm,
			b.VisitContent,
			c.Name AS userInfoName,
			b.IsVisit,
			b.IsDel,
			b.Remarks,
			a.IsDel AS cIsDel
		FROM
			customerinfo a,
			visitinfo b,
			userinfo c
		WHERE
			a.Id = b.CustomerId
		AND b.IsVisit = 2
		AND b.IsDel = 0
		AND b.UserInfoId = c.Id	
		<if test="customerName !=null  and customerName != '' ">
		AND a.CustomerCode like '%${customerName}%'
		</if>
		ORDER BY b.Id DESC
	</select>
	
	<select id="findByNameAndId"  parameterType="String" resultType="Client_back">
	SELECT
			a.Id,
			a.CustomerId,
			b.customerName AS customerName,
			b.CustomerCode,
			a.VisitDate,
			a.VisitForm,
			a.VisitContent,
			a.UserInfoId,
			u.Name AS userInfoName,
			a.IsVisit,
			a.Remarks,
			b.IsDel as cIsDel,
			c.Province
		FROM
		visitinfo as a
		LEFT JOIN customerinfo as b ON  a.CustomerId = b.id
		LEFT JOIN cityinfo as ci on b.CityId = ci.Id
		LEFT JOIN provinceinfo as c on  ci.ProvinceId = c.Id
		LEFT JOIN userinfo as u on  a.UserInfoId = u.id
		where a.isDel =0
		and a.IsVisit = 2
		<if test="pid != 'null'">
			<if test="pid == '客户信息'">
				AND c.Province = #{id}
			</if>
			<if test="pid != '客户信息' ">
				and b.Id = #{id}
				AND c.Province =#{pid}
			</if>
		</if>
		order by a.Id desc
	</select>
</mapper>